@startuml
!include design.plantuml.txt
title 3.02 mHealth - get document for health pro (3. SMART on FHIR option)

actor user as "Health Professional"

box "mHealth App" #BFCAD2
	participant app as "App GUI\nIUA Authorization Client"
    participant pixmconsumer as "Patient Identifier Cross-\nreference Consumer"
end box

box "mHealth embedded App" #BDBED0
	participant app2 as "App GUI\nIUA Authorization Client"
    participant docconsumer as "Document Consumer (MHD)"
end box


box "Community Components" #FFEFDE
	participant mp_AuthorizationServer as "Authorization Server (IUA)"
	participant mp_pix_x_ref_mgr as "Patient Identifier \nCross-reference \nMange"
	participant mp_doc_responder as "Document Responder (MHD)"
end box

box "IdP" #DFF3F7
	participant idp_user_authentication_provider as "User \nAuthentication \nProvider"
end box

user -[#black]> app: read doc
activate app


!include_many step_mh_idp.scope.plantuml.txt

!include_many step_mh_pixm.plantuml.txt

app -> app2: launch app
activate app2

app2 -> mp_AuthorizationServer: IUA Get Authorization Token
activate mp_AuthorizationServer
mp_AuthorizationServer -> idp_user_authentication_provider: Authenticate User
activate idp_user_authentication_provider
mp_AuthorizationServer <- idp_user_authentication_provider
deactivate idp_user_authentication_provider
mp_AuthorizationServer -[#black]> mp_AuthorizationServer: Authorize App Access
mp_AuthorizationServer -> app2: On Approval redirect to app with code
deactivate mp_AuthorizationServer
app2 -> mp_AuthorizationServer: Exchange code for access token
activate mp_AuthorizationServer
app2 <- mp_AuthorizationServer: access token for response [JWT:UAP-ID]
deactivate mp_AuthorizationServer


app2 -[#black]> docconsumer: query documents
activate docconsumer
app2 <[#black]- docconsumer
deactivate docconsumer

app2 -[#black]> mp_doc_responder: retrieve document
activate mp_doc_responder
app2 <[#black]- mp_doc_responder
deactivate mp_doc_responder

app <[#black]- app2
deactivate app2

user <[#black]- app
deactivate app

@enduml 
