@startuml
!include design.plantuml.txt
title 3.01 mHealth - get document for patient

actor user as "Patient"

box "App" #BFCAD2
	participant app as "App"
    participant pixmconsumer as "Patient Identifier Cross-\nreference Consumer (PIXm)"
    participant docconsumer as "Document Consumer (MHD)"
end box

box "Mobile Portal" #DEEDE0
	participant mp_fhirserver as "FHIR API"
	participant mp_pix_x_ref_mgr as "Patient Identifier Cross-reference Manager (PIXm)\nPatient Identifier Cross-reference Consumer (PIXV3)"
	participant mp_doc_responder as "Document Responder (MHD)\nDocument Consumer (XDS) | X-Service User"
end box

box "IdP" #DFF3F7
	participant idp_user_authentication_provider as "User \nAuthentication \nProvider"
end box

box "Community Components" #FFEFDE
	participant cc_x_assertion_provider as "X-Assertion Provider" 
	participant cc_doc_registry as "Document Registry | X-Service Provider | Authorization Decision Consumer | X-Service User\nInitiating Gateway | X-Service Provider" 
	participant cc_mpi_x_ref_manager as "Patient Identifier \nCross-reference \nManger"
end box

box "Secondary Systems" #F7A69E
	participant ss_doc_repository as "Document Repository | X-Service Provider" 
end box

user -> app: read doc
activate app

app -> mp_fhirserver: GET /metadata
activate mp_fhirserver
app <- mp_fhirserver: Conformance statement incl. OAuth 2.0 endpoints
deactivate mp_fhirserver
app -> idp_user_authentication_provider: Redirect to Authz Server (SMART standalone launce sequence)
activate idp_user_authentication_provider
idp_user_authentication_provider -> idp_user_authentication_provider: Authenticate and authorize User
idp_user_authentication_provider -> app: On Approval redirect to app with code
deactivate idp_user_authentication_provider
app -> idp_user_authentication_provider: Exchange code for access token
activate idp_user_authentication_provider
app <- idp_user_authentication_provider: access token for response
deactivate idp_user_authentication_provider

app -> pixmconsumer: get MPI_PID
activate pixmconsumer
pixmconsumer -> mp_pix_x_ref_mgr: [ITI-83] Mobile Patient Identifier Cross-reference Query 
activate mp_pix_x_ref_mgr
mp_pix_x_ref_mgr -> mp_pix_x_ref_mgr: PIXm to PIX V3
activate mp_pix_x_ref_mgr

mp_pix_x_ref_mgr -> cc_mpi_x_ref_manager: ITI-45 PIX V3 Query [UAP ID]
activate cc_mpi_x_ref_manager
mp_pix_x_ref_mgr <- cc_mpi_x_ref_manager: ITI-45 PIX V3 Response [MPI_A-PID, EPR-SPID]
deactivate cc_mpi_x_ref_manager

deactivate mp_pix_x_ref_mgr
pixmconsumer <- mp_pix_x_ref_mgr: [ITI-83] PIXm Query Response [MPI_A-PID, EPR-SPID]
deactivate mp_pix_x_ref_mgr
app <- pixmconsumer: 
deactivate pixmconsumer

app -> docconsumer: query documents
activate docconsumer
docconsumer -> mp_doc_responder: [ITI-67] Find Document References 
activate mp_doc_responder
mp_doc_responder -> mp_doc_responder: MHD to XDS
activate mp_doc_responder
mp_doc_responder -> cc_x_assertion_provider: CH:XUA Get-XUser Assertions [UAP-ID]
activate cc_x_assertion_provider
mp_doc_responder <- cc_x_assertion_provider: CH:XUA Get-XUser Assertions Response [EPR-SPID] according to CH:XUA
deactivate cc_x_assertion_provider

mp_doc_responder -> cc_doc_registry: [ITI-18] Registry Stored Query [MPI_A-PID]\ngrouped with [ITI-40] Provide X-User Assertion [EPR-SPID]
activate cc_doc_registry
mp_doc_responder <- cc_doc_registry: [ITI-18] Registry Stored Query Response
deactivate cc_doc_registry
deactivate mp_doc_responder
docconsumer <- mp_doc_responder
deactivate mp_doc_responder
app <- docconsumer
deactivate docconsumer

app -> docconsumer: retrieve document
activate docconsumer
docconsumer -> mp_doc_responder: [ITI-68] Retrieve Document
activate mp_doc_responder
mp_doc_responder -> mp_doc_responder: MHD to XDS

activate mp_doc_responder
mp_doc_responder -> cc_x_assertion_provider: CH:XUA Get-XUser Assertions [UAP-ID]
activate cc_x_assertion_provider
mp_doc_responder <- cc_x_assertion_provider: CH:XUA Get-XUser Assertions Response [EPR-SPID] according to CH:XUA
deactivate cc_x_assertion_provider

mp_doc_responder -> ss_doc_repository: [ITI-43] Retrieve Document Set Request\ngrouped with [ITI-40] Provide X-User Assertion [EPR-SPID]
activate ss_doc_repository
mp_doc_responder <- ss_doc_repository: [ITI-43] Retrieve Document Set Response
deactivate ss_doc_repository


deactivate mp_doc_responder
docconsumer <- mp_doc_responder
deactivate mp_doc_responder
app <- docconsumer
deactivate docconsumer

user <- app
deactivate app

@enduml 
